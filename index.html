const SPREADSHEET_ID = '1BFvR6lffQe1fSp-6L1zZqVPvzKjw46dAJ9gK-Wj2MB8';  // è«‹æ›¿æ›æˆä½ çš„å¯¦éš› Spreadsheet ID 

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index');
}

// å‚³ Products çµ¦å‰ç«¯
function getProducts() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('å•†å“è³‡æ–™');
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];
  const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
  return data.map(r => ({
    id: r[0],
    name: r[1],
    price: r[2],
    unit: r[3],
    desc: r[4]
  }));
}

// å‚³ Clients è³‡æ–™çµ¦å‰ç«¯
function getClients() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('å®¢æˆ¶åŸºæœ¬è³‡æ–™');
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];
  const data = sheet.getRange(2, 1, lastRow - 1, 18).getValues();
  return data.map(r => ({
    name: r[3],
    shortName: r[4],
    invoiceNumber: r[5],
    contact: r[6],
    mobile: r[7],
    tel: r[8],
    tel2: r[9],
    address: r[10],
    paymentMethod: r[11],
    paymentDays: r[12],
    paymentDate: r[13],
    salesperson: r[14],
    tripNumber: String(r[15] ?? ''),   // âœ… è»Šæ¬¡å¼·åˆ¶ç‚ºå­—ä¸²
    email: r[16],
    note: r[17]
  }));
}

// ç”¢ç”Ÿæ–°çš„è¨‚å–®ç·¨è™Ÿ
function generateOrderId() {
  const lock = LockService.getScriptLock();
  try {
    // ç­‰å¾…æœ€å¤š30ç§’æ‹¿é–ï¼Œé¿å…æ­»ç­‰
    lock.waitLock(30000);

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('çµå¸³');
    const now = new Date();
    const year = now.getFullYear() - 1911;
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const prefix = `${year}${month}${day}`;

    const lastRow = sheet.getLastRow();
    let maxNum = 0;
    let existingIds = [];

    if (lastRow >= 2) {
      existingIds = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
      existingIds.forEach(id => {
        if (id != null) {
          const idStr = String(id);
          if (idStr.startsWith(prefix)) {
            const numPart = idStr.slice(prefix.length);
            const num = parseInt(numPart, 10);
            if (!isNaN(num) && num > maxNum) {
              maxNum = num;
            }
          }
        }
      });
    }

    let newNum = maxNum + 1;
    let newId = prefix + String(newNum).padStart(4, '0');

    while (existingIds.includes(newId)) {
      newNum++;
      newId = prefix + String(newNum).padStart(4, '0');
    }

    return newId;

  } catch (e) {
    throw new Error('ç„¡æ³•å–å¾—é–ï¼Œè«‹ç¨å¾Œé‡è©¦');
  } finally {
    // é‡‹æ”¾é–ï¼ˆä¸ä¸€å®šè¦å¯«ï¼Œè…³æœ¬çµæŸæœƒè‡ªå‹•é‡‹æ”¾ï¼‰
    lock.releaseLock();
  }
}


function addNewOrder(dateString) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('çµå¸³');
  const orderId = generateOrderId();
  const orderDate = dateString ? new Date(dateString) : new Date();

  // æ°¸é ç”¨ appendRowï¼Œå®‰å…¨è™•ç†ç©ºè¡¨
  sheet.appendRow([orderId, orderDate]);

  SpreadsheetApp.flush();
  return orderId;
}



// âœ… æä¾›å‰ç«¯ç”¨çš„ä½¿ç”¨è€…åˆ—è¡¨
function getAllCreators() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('ä½¿ç”¨è€…');
  if (!sheet) return [];

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];

  const names = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
  return names.filter(name => name);
}

function getEmployees() {
  return getAllCreators(); // åŒåŠŸèƒ½
}

/**
 * å»ºç«‹æˆ–æ›´æ–°è¨‚å–®ã€‚
 */

function saveOrder(order) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000);

    if (!order.client || order.client.trim() === '') throw new Error('å®¢æˆ¶åç¨±ä¸å¯ç‚ºç©º');
    if (!order.items || !order.items.length) throw new Error('è¨‚å–®æ²’æœ‰æ˜ç´°');

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const orderSheet = ss.getSheetByName('çµå¸³');
    const detailSheet = ss.getSheetByName('éŠ·è²¨æ˜ç´°');
    const productSheet = ss.getSheetByName('å•†å“è³‡æ–™');
    const clientSheet = ss.getSheetByName('å®¢æˆ¶åŸºæœ¬è³‡æ–™');
    if (!orderSheet || !detailSheet || !productSheet || !clientSheet)
      throw new Error('æ‰¾ä¸åˆ°å·¥ä½œè¡¨');

    const productData = productSheet.getDataRange().getValues();
    const clientData = clientSheet.getDataRange().getValues();
    const clientMap = new Map(clientData.slice(1).map(r => [String(r[3]).trim(), r[1]]));

    // -------- è¨ˆç®—è¨‚å–®é‡‘é¡ ----------
    order.items.forEach(i => {
      i.qty = Number(i.qty) || 0;
      i.price = Number(i.price) || 0;
      i.weight = Number(i.weight) || 0;
      i.convertUnit = Number(i.convertUnit) || 1;
      i.subtotal = i.subtotal !== undefined ? Number(i.subtotal)
        : (i.weight > 0 ? i.weight * i.convertUnit * i.price : i.qty * i.price);
    });

    const totalAmount = order.items.reduce((sum, i) => sum + i.subtotal, 0);
    const discount = parseFloat(order.discount) || 0;
    const subtotal = totalAmount - discount;
    const tax = order.taxable ? Math.round(subtotal * 0.05) : 0;
    const total = Math.round(subtotal + tax);

    // -------- å–å¾—æ‰€æœ‰è¨‚å–® ----------
    const allOrders = orderSheet.getDataRange().getValues();
    const headers = allOrders[0];
    const existingIds = new Set(allOrders.slice(1).map(r => String(r[0])));
    let orderId = order.orderId;

    // -------- æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒè¨‚å–® ----------
    if (!orderId) {
      const sameOrder = allOrders.slice(1).find(r => {
        const clientMatch = String(r[2]).trim() === order.client.trim();
        const dateMatch = r[1] && new Date(r[1]).getTime() === new Date(order.dateStr || new Date()).getTime();
        return clientMatch && dateMatch;
      });
      if (sameOrder) orderId = sameOrder[0];
    }

    // -------- ç”Ÿæˆå–®è™Ÿï¼ˆå¦‚æœéœ€è¦ï¼‰ ----------
    if (!orderId || order.mode === 'copy') {
      do { orderId = generateOrderId(); } while (existingIds.has(orderId));
    }

    // -------- æ–°çš„ä¸»æª”è³‡æ–™ ----------
    const newOrderRow = [
      orderId,
      new Date(order.dateStr || new Date()),
      order.client || '',
      order.invoiceNumber || '',
      order.contact || '',
      order.mobile || '',
      order.tel || '',
      order.clientAddress || '',
      order.paymentMethod || '',
      order.paymentDays || '',
      order.paymentDate || '',
      order.salesperson || '',
      String(order.tripNumber ?? ''),
      order.email || '',
      totalAmount,
      discount,
      tax,
      total,
      order.creator || ''
          ];

    // -------- æ¯”å°ä¸¦æ›´æ–°çµå¸³è¡¨ï¼ˆåªæ”¹è©²æ›´æ–°æ¬„ä½ï¼‰ ----------
    const orderMap = new Map();
    for (let i = 1; i < allOrders.length; i++) {
      const id = String(allOrders[i][0]).trim();
      if (id) orderMap.set(id, { rowIndex: i + 1, values: allOrders[i] });
    }

    if (orderMap.has(orderId)) {
      const { rowIndex, values } = orderMap.get(orderId);
      for (let c = 0; c < newOrderRow.length; c++) values[c] = newOrderRow[c];
      orderSheet.getRange(rowIndex, 1, 1, values.length).setValues([values]);
    } else {
      orderSheet.appendRow(newOrderRow);
    }
   // -------- å¯«å…¥æ˜¯å¦æ‡‰ç¨…åˆ° X æ¬„ï¼ˆç¬¬24æ¬„ï¼‰ ----------
    const lastRow = orderMap.has(orderId)
    ? orderMap.get(orderId).rowIndex
    : orderSheet.getLastRow();

    orderSheet.getRange(lastRow, 24).setValue(order.taxable ? 'æ‡‰ç¨…' : 'å…ç¨…');
    // -------- æ›´æ–°éŠ·è²¨æ˜ç´°ï¼ˆæ¯”å° N æ¬„ï¼‰ ----------
    const detailValues = detailSheet.getDataRange().getValues();
    const dataRows = detailValues.slice(1);

    const detailMap = new Map(); // key = Næ¬„
    for (let i = 0; i < dataRows.length; i++) {
      const key = String(dataRows[i][13] || '').trim(); // ç¬¬14æ¬„ N
      if (key) detailMap.set(key, { rowIndex: i + 2, values: dataRows[i] });
    }

    order.items.forEach(item => {
      const key = `${orderId}_${String(item.name).trim()}`;
      let supplier = '';
      for (let j = 1; j < productData.length; j++) {
        if (String(productData[j][0]) === String(item.id)) {
          supplier = productData[j][4] || '';
          break;
        }
      }

      const newRow = [
        orderId, item.id || '', item.name || '', item.qty, item.price,
        item.priceUnit || '', item.shipQty || 0,
        item.convertQty || 0, item.convertUnitName || '',
        item.subtotal, order.salesperson || '', order.tripNumber || '', supplier, key
      ];

      if (detailMap.has(key)) {
        const { rowIndex, values } = detailMap.get(key);
        for (let c = 0; c < newRow.length; c++) values[c] = newRow[c];
        detailSheet.getRange(rowIndex, 1, 1, values.length).setValues([values]);
      } else {
        detailSheet.appendRow(newRow);
      }
    });

// -------- å®¢æˆ¶è³‡æ–™åŒæ­¥åˆ°éŠ·è²¨æ˜ç´° ----------
const checkoutMap = new Map();
const updatedOrders = orderSheet.getDataRange().getValues(); // æœ€æ–°çš„ä¸»æª”è³‡æ–™
for (let i = 1; i < updatedOrders.length; i++) {
  const id = String(updatedOrders[i][0] || '').trim();
  if (!id) continue;
  checkoutMap.set(id, {
    AA: clientMap.get(String(updatedOrders[i][2] || '').trim()) || '',  // å®¢æˆ¶ä»£è™Ÿ
    C: String(updatedOrders[i][2] || ''), // å®¢æˆ¶åç¨±
    B: updatedOrders[i][1]
      ? Utilities.formatDate(new Date(updatedOrders[i][1]), Session.getScriptTimeZone(), 'yyyy/MM/dd')
      : '',
    L: updatedOrders[i][11] || '', // æ¥­å‹™
    // é€™è£¡ç›´æ¥è½‰æˆå­—ä¸²ï¼Œå¦‚æœç‚º null æˆ– undefined å°±ç”¨ç©ºå­—ä¸²
    M: updatedOrders[i][12] != null ? String(updatedOrders[i][12]) : '', 
    S: updatedOrders[i][18] || '' // å»ºç«‹è€…
  });
}

const detailRange = detailSheet.getDataRange();
const detailData = detailRange.getValues();
for (let i = 1; i < detailData.length; i++) {
  const id = String(detailData[i][0] || '').trim();
  const match = checkoutMap.get(id);
  if (!match) continue;
  detailData[i][18] = match.AA; // å®¢æˆ¶ä»£è™Ÿ
  detailData[i][17] = match.C;  // å®¢æˆ¶åç¨±
  detailData[i][14] = match.B;  // æ—¥æœŸ
  detailData[i][10] = match.L;  // æ¥­å‹™
  detailData[i][11] = match.M;  // è»Šè¶Ÿï¼Œå·²ç¶“æ˜¯å­—ä¸²ï¼Œ0 ä¹Ÿæœƒé¡¯ç¤º
  detailData[i][16] = match.S;  // å»ºç«‹è€…
}

// å¯«å›åŒæ­¥å¾Œçš„æ˜ç´°
detailSheet.getRange(1, 1, detailData.length, detailData[0].length).setValues(detailData);

return { success: true, orderId };



  } catch (err) {
    Logger.log('âŒ saveOrder error: ' + err.stack);
    return { success: false, message: err.message };
  } finally {
    lock.releaseLock();
  }
}




// å¯é¸ï¼šå¾Œç«¯ä¹ŸåŠ å…¥ convertWeight å‡½æ•¸ï¼Œå¦‚æœä½ åœ¨å¾Œç«¯éœ€è¦ç”¨é€™å€‹æ›ç®—é‚è¼¯
function convertWeight(weight, fromUnit, toUnit) {
  if (fromUnit === toUnit) return weight;
  if (fromUnit === 'å°æ–¤' && toUnit === 'å…¬æ–¤') return weight * 0.6;
  if (fromUnit === 'å…¬æ–¤' && toUnit === 'å°æ–¤') return weight / 0.6;
  return weight;
}


function updateProductPrice(productName, newPrice) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('å•†å“è³‡æ–™');
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    const nameInSheet = String(data[i][1]).trim(); // Bæ¬„ = å•†å“åç¨±
    if (nameInSheet === productName.trim()) {
      sheet.getRange(i + 1, 3).setValue(newPrice); // Cæ¬„ = å–®åƒ¹
      break;
    }
  }
}


/************************************************************
 *  ğŸ”§ Utilityï¼šæ¸…ç†å­—ä¸²ï¼ˆé©ç”¨æ–¼è¨‚å–®IDã€æ¯”å°ç”¨å­—ä¸²ï¼‰
 ************************************************************/
function cleanString(str) {
  if (str === null || str === undefined) return '';

  return str
    .toString()               // ç¢ºä¿è½‰æˆå­—ä¸²
    .trim()                   // å»é™¤å‰å¾Œç©ºç™½
    .replace(/\s+/g, '')      // ç§»é™¤ä¸­é–“ç©ºç™½
    .replace(/\u3000/g, '')   // ç§»é™¤å…¨å½¢ç©ºç™½
    .replace(/\r?\n/g, '')    // ç§»é™¤æ›è¡Œç¬¦è™Ÿ
    .replace(/[^\x20-\x7E\u4E00-\u9FFF]/g, '') // æ¸…é™¤æ§åˆ¶å­—å…ƒ
    .toUpperCase();           // çµ±ä¸€å¤§å¯«ï¼ˆé¿å… A001 vs a001ï¼‰
}


/************************************************************
 *  ğŸ“¦ ä¸»åŠŸèƒ½ï¼šä¾è¨‚å–®ç·¨è™Ÿå–å¾—å®Œæ•´è¨‚å–®è³‡æ–™
 *  ä¿®æ­£ç‰ˆï¼šè§£æ±ºã€Œæ—¥æœŸæ°¸é ç‚ºä»Šå¤©ã€å•é¡Œ
 *  âœ… æ”¯æ´ B æ¬„ã€Œä¸‹å–®æ—¥æœŸã€
 *  âœ… ç¢ºä¿å‰ç«¯ä¸€å®šæœ‰ data['è¨‚å–®æ—¥æœŸ']
 ************************************************************/
function getOrderData(orderId) {
  const cleanInputId = cleanString(orderId);
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const ordersSheet = ss.getSheetByName('çµå¸³');
  const detailsSheet = ss.getSheetByName('éŠ·è²¨æ˜ç´°');

  if (!ordersSheet) return null;

  const orders = ordersSheet.getDataRange().getDisplayValues();
  const details = detailsSheet ? detailsSheet.getDataRange().getDisplayValues() : [];

  if (!orders || orders.length < 2) return null;

  const headers = orders[0].map(h => h.toString().trim());
  const idColIndex = 0;

  let orderData = null;

  // ---------- æ‰¾è¨‚å–® ----------
  for (let i = 1; i < orders.length; i++) {
    if (cleanString(orders[i][idColIndex]) === cleanInputId) {
      orderData = {};
      headers.forEach((h, idx) => {
        orderData[h] = orders[i][idx];
      });
      orderData.details = [];

      // âœ… å¼·åˆ¶è£œä¸Šæ—¥æœŸï¼ˆB æ¬„ï¼‰
      // å³ä½¿è¡¨é ­ä¸æ˜¯ã€Œè¨‚å–®æ—¥æœŸã€ï¼Œä¹Ÿèƒ½ä¿è­‰æœ‰å€¼
      if (!orderData['ä¸‹å–®æ—¥æœŸ'] && orders[i][1]) {
        orderData['ä¸‹å–®æ—¥æœŸ'] = orders[i][1];
      }

      break;
    }
  }

  if (!orderData) return null;

  // ---------- ç¨…é‡‘ & æ˜¯å¦èª²ç¨… ----------
  const taxColIndex = 16; // Q æ¬„ (index = 16)
  const taxValue = parseFloat(orderData[headers[taxColIndex]] || 0);
  orderData['çµå¸³ç¨…é‡‘'] = taxValue;
  orderData['æ˜¯å¦èª²ç¨…'] = taxValue > 0;

  // ---------- æ‰¾å‡ºå•†å“æ˜ç´° ----------
  if (details && details.length >= 2) {
    for (let j = 1; j < details.length; j++) {
      const row = details[j];
      const detailId = cleanString(row[0]);
      if (detailId === cleanInputId) {
        const detailRow = {
          orderId: row[0],
          id: row[1],
          name: row[2],
          qty: parseFloat(row[3]) || 0,
          price: parseFloat(row[4]) || 0,
          priceUnit: row[5] || '',
          shipQty: parseFloat(row[6]) || 0,
          convertQty: parseFloat(row[7]) || 0,
          convertUnitName: row[8] || '',
          subtotal: parseFloat(row[9]) || 0,
          salesperson: row[10] || '',
          tripNumber: String(row[11] ?? ''),
          supplier: row[12] || '',
          key: row[13] || ''
        };
        orderData.details.push(detailRow);
      }
    }
  }

  /************************************************************
   *  ğŸ—“ çµ±ä¸€æ—¥æœŸæ¬„ä½è™•ç†
   *  â†’ ä¸ç®¡è¡¨é ­æ˜¯ã€Œä¸‹å–®æ—¥æœŸã€ã€ã€Œè¨‚å–®æ—¥æœŸã€æˆ–ã€Œæ—¥æœŸã€
   *    éƒ½æœƒè½‰æˆã€Œè¨‚å–®æ—¥æœŸã€
   ************************************************************/
  const possibleDateKeys = ['ä¸‹å–®æ—¥æœŸ', 'è¨‚å–®æ—¥æœŸ', 'æ—¥æœŸ', 'date', 'Date', 'dateStr'];
  let orderDate = '';

  for (const key of possibleDateKeys) {
    if (orderData[key]) {
      orderDate = orderData[key];
      break;
    }
  }

  // æ ¼å¼åŒ–æˆ YYYY/MM/DD
  if (orderDate) {
    if (orderDate instanceof Date) {
      const yyyy = orderDate.getFullYear();
      const mm = (orderDate.getMonth() + 1).toString().padStart(2, '0');
      const dd = orderDate.getDate().toString().padStart(2, '0');
      orderDate = `${yyyy}/${mm}/${dd}`;
    } else if (typeof orderDate === 'string') {
      orderDate = orderDate.split(' ')[0].replace(/-/g, '/');
    }
  } else {
    // è‹¥ç„¡æ—¥æœŸæ¬„ä½ï¼Œé è¨­ä»Šå¤©
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = (today.getMonth() + 1).toString().padStart(2, '0');
    const dd = today.getDate().toString().padStart(2, '0');
    orderDate = `${yyyy}/${mm}/${dd}`;
  }

  // âœ… ç¢ºä¿å›å‚³ä¸€å®šæœ‰ã€Œè¨‚å–®æ—¥æœŸã€
  orderData['è¨‚å–®æ—¥æœŸ'] = orderDate;
  

  return orderData;
}

// å…¬å¸è³‡æ–™
function getCompanyInfo() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName("å…¬å¸åŸºæœ¬è³‡æ–™");
  if (!sheet) return null;

  const companyName = sheet.getRange("A2").getValue();
  const companyTel = sheet.getRange("D2").getValue();
  const companyNote = sheet.getRange("F2").getValue();

  return {
    name: companyName,
    tel: companyTel,
    note: companyNote
  };
}

// åˆªé™¤è¨‚å–®
function deleteOrder(orderId) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const orderSheet = ss.getSheetByName('çµå¸³');
  const detailSheet = ss.getSheetByName('éŠ·è²¨æ˜ç´°');

  const detailVals = detailSheet.getDataRange().getValues();
  const delRowsDetail = [];

  for (let i = 1; i < detailVals.length; i++) {
    if (String(detailVals[i][0]) === String(orderId)) {
      delRowsDetail.push(i + 1);
    }
  }

  delRowsDetail.reverse().forEach(r => {
    detailSheet.deleteRow(r);
  });

  const ords = orderSheet.getDataRange().getValues();
  for (let i = 1; i < ords.length; i++) {
    if (String(ords[i][0]) === String(orderId)) {
      orderSheet.deleteRow(i + 1);
      break;
    }
  }

  return true;
}

function createPdfFromHtml(htmlContent, fileName) {
  const blob = Utilities.newBlob(htmlContent, 'text/html', 'temp.html');
  const pdf = blob.getAs('application/pdf').setName(fileName);
  // å°‡ PDF æ”¾åˆ°ä½¿ç”¨è€… Google Drive æˆ–æä¾›ä¸‹è¼‰é€£çµ
  const file = DriveApp.createFile(pdf);
  return file.getUrl(); // å–å¾—ä¸‹è¼‰ URL
}
